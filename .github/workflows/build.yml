name: Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  generate:
    name: "${{ github.event_name }} / generate"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: DeterminateSystems/nix-installer-action@main
    - uses: DeterminateSystems/magic-nix-cache-action@main

    - run: go generate
      shell: nix develop -c bash -e {0}

    - name: Git dirty check
      run: |
        git add .
        if [[ -n "$(git status --porcelain)" ]]; then
          PAGER= git diff --cached
          exit 1
        fi
  build:
    strategy:
      matrix:
        os:
          - ubuntu-22.04
          # - windows-latest
          - macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      # - name: install mingw 11.2.0 using choco
      #   if: runner.os == 'Windows'
      #   shell: powershell
      #   run: choco install mingw --version 11.2.0

      # - name: Add mingw to path on windows
      #   if: runner.os == 'Windows'
      #   run: Add-Content $env:GITHUB_PATH "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin"
      #   shell: powershell

      # - name: install pkgconfiglite using choco
      #   if: runner.os == 'Windows'
      #   shell: powershell
      #   run: choco install pkgconfiglite --allow-empty-checksums

      - uses: actions/checkout@v4

      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: build
        shell: bash
        run: ./buildAll.sh